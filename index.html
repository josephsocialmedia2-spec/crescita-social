<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NON VENDIAMO — RISOLVIAMO (Acquisizione Seduti)</title>
  <style>
    :root{
      --bg:#070709;
      --card:#0f1013;
      --card2:#0b0c0f;
      --text:#f4f4f5;
      --muted:#a1a1aa;
      --line:#23252b;
      --gold:#d4af37;
      --gold2:#b8942e;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(7,7,9,.92);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      padding:12px 16px;display:flex;gap:10px;align-items:center
    }
    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .tiny{font-size:12px;color:var(--muted)}
    main{max-width:1300px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    .card h2{margin:0 0 10px 0;font-size:14px}
    .card h3{margin:0 0 8px 0;font-size:13px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--line);
      border-radius:14px;font-size:14px;background:#0b0c0e;color:var(--text)
    }
    textarea{min-height:90px;resize:vertical}
    select{appearance:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hr{height:1px;background:var(--line);margin:12px 0}

    button{
      border:1px solid var(--line);
      background:#0b0c0e;
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
    }
    button:active{transform:translateY(1px)}
    button.gold{
      background:linear-gradient(180deg,var(--gold),var(--gold2));
      border-color:rgba(212,175,55,.35);
      color:#070709;
      font-weight:900;
      letter-spacing:.2px;
    }
    button.ghost{
      background:transparent;border-color:rgba(212,175,55,.25);color:var(--gold);
    }
    button.danger{
      background:transparent;border-color:rgba(239,68,68,.55);color:var(--danger);
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(212,175,55,.25);
      border-radius:999px;padding:6px 10px;
      font-size:12px;color:var(--gold);
      background:rgba(212,175,55,.06)
    }
    .pill.ok{border-color:rgba(34,197,94,.35);color:#86efac;background:rgba(34,197,94,.08)}
    .pill.bad{border-color:rgba(239,68,68,.35);color:#fecaca;background:rgba(239,68,68,.08)}
    .pill.warn{border-color:rgba(245,158,11,.35);color:#fde68a;background:rgba(245,158,11,.08)}
    .pill.muted{border-color:rgba(161,161,170,.25);color:var(--muted);background:rgba(161,161,170,.05)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    tbody td{
      padding:10px;border-top:1px solid var(--line);border-bottom:1px solid var(--line);
      vertical-align:top;background:rgba(255,255,255,.02)
    }
    tbody td:first-child{border-left:1px solid var(--line);border-top-left-radius:14px;border-bottom-left-radius:14px}
    tbody td:last-child{border-right:1px solid var(--line);border-top-right-radius:14px;border-bottom-right-radius:14px}

    a.link{
      color:var(--gold);text-decoration:none;border-bottom:1px dashed rgba(212,175,55,.35)
    }

    .banner{
      border:1px solid rgba(212,175,55,.25);
      background:rgba(212,175,55,.07);
      border-radius:16px;padding:12px;
    }
    .banner b{color:var(--gold)}
    .hint{
      border:1px dashed rgba(212,175,55,.25);
      background:rgba(212,175,55,.06);
      border-radius:14px;padding:10px
    }
    .step{
      border:1px solid rgba(212,175,55,.22);
      background:rgba(212,175,55,.06);
      border-radius:16px;padding:12px;
    }
    .step .do{font-weight:950;color:var(--gold);margin-bottom:6px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .actions.left{justify-content:flex-start}
    .kbd{border:1px solid var(--line);background:#0b0c0e;border-radius:10px;padding:4px 8px;font-size:12px;color:var(--muted)}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <h1>NON VENDIAMO — RISOLVIAMO</h1>
  <span class="tiny">Acquisizione da seduti: clicca → copia/incolla → salva contatto</span>
  <span style="flex:1"></span>
  <button id="btnExport" class="ghost">Esporta</button>
  <button id="btnImport" class="ghost">Importa</button>
  <button id="btnReset" class="danger">Reset</button>
</header>

<main>
  <div class="grid">
    <!-- LEFT: FLOW GUIDATO -->
    <section class="card">
      <div class="banner">
        <div class="tiny">REGOLA MADRE</div>
        <div style="font-size:14px;line-height:1.35">
          <b>NON vendiamo.</b> Risolviamo.<br/>
          Facendo così <b>loro parlano</b> (“perché?” “come mai?” “cosa è successo?”) e si apre la comunicazione.
        </div>
      </div>

      <div class="hr"></div>

      <h2>SETUP (una volta)</h2>
      <div class="two">
        <div>
          <label>Settore (1 riga)</label>
          <input id="niche" placeholder="Es: social per ristoranti" />
        </div>
        <div>
          <label>Piattaforma principale</label>
          <select id="mainPlatform">
            <option value="instagram">Instagram</option>
            <option value="tiktok">TikTok</option>
            <option value="linkedin">LinkedIn</option>
            <option value="facebook">Facebook</option>
            <option value="x">X</option>
          </select>
        </div>
      </div>

      <div class="two">
        <div>
          <label>✅ COME SCRIVE LA GENTE QUANDO HA UN PROBLEMA (1 frase per riga)</label>
          <div class="tiny">FAI COSÌ: apri social → leggi commenti → copia una frase reale → incolla qui.</div>
          <textarea id="keywords" placeholder="Es:
non riesco a trovare clienti
qualcuno sa come crescere su instagram
mi serve aiuto con i social
come faccio a vendere online
cerco qualcuno che mi segua i social"></textarea>
          <div class="tiny" style="margin-top:6px">
            ❌ NO parole tecniche (“marketing digitale”, “lead generation”) — ✅ SI frasi da persona normale.
          </div>
        </div>
        <div>
          <label>Competitor / pagine (1 per riga) — @nome o URL</label>
          <textarea id="competitors" placeholder="Es:
@competitor1
@competitor2
https://www.instagram.com/competitor3/"></textarea>

          <label style="margin-top:10px">Gruppi / community (1 per riga) — nome o URL</label>
          <textarea id="groups" placeholder="Es:
Gruppo Facebook: Marketing Italia
https://www.linkedin.com/groups/123456/
Discord: Growth Hacking Italia"></textarea>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Quota contatti / giorno</label>
              <select id="quota">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="30">30</option>
              </select>
            </div>
            <div>
              <label>Timer (minuti)</label>
              <select id="timerMin">
                <option value="15">15</option>
                <option value="30" selected>30</option>
                <option value="45">45</option>
                <option value="60">60</option>
              </select>
            </div>
          </div>

          <div class="actions" style="margin-top:10px">
            <button id="btnSave" class="ghost">Salva setup</button>
            <button id="btnGenerate" class="gold">GENERA LA GIORNATA</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <h2>FLOW (fai in ordine, seduto)</h2>

      <div class="row">
        <span class="pill ok" id="progressPill">Oggi: 0 / 0 contatti salvati</span>
        <span class="pill muted" id="timerPill">Timer: 00:00</span>
        <button id="btnStartTimer" class="gold">START</button>
        <button id="btnStopTimer" class="ghost">STOP</button>
        <button id="btnNewDay" class="ghost">Nuovo giorno</button>
      </div>

      <div class="hr"></div>

      <div class="step">
        <div class="do">STEP 1 — CLICCA LINK → TROVA PERSONE</div>
        <div class="tiny">Clicca un link → apri post recenti → trova chi chiede aiuto → vai ai commenti.</div>
        <div class="row" style="margin-top:10px" id="searchLinks"></div>
      </div>

      <div class="hr"></div>

      <div class="step">
        <div class="do">STEP 2 — COMMENTO “RISOLVO” (copia/incolla)</div>
        <div class="tiny">
          Clicca <b>COPIA</b> → incolla sotto il post → personalizza 1 parola → invia.
          <span class="kbd">Regola</span> niente link, niente vendita.
        </div>
        <div class="actions left" style="margin-top:10px">
          <button id="btnCopyQ1" class="gold">COPIA: “Perché è successo?”</button>
          <button id="btnCopyQ2" class="ghost">COPIA: “Cosa hai provato?”</button>
          <button id="btnCopyQ3" class="ghost">COPIA: “Parlami del tuo caso”</button>
        </div>
        <label style="margin-top:10px">Testo copiato (solo per vedere)</label>
        <textarea id="preview" class="mono"></textarea>
      </div>

      <div class="hr"></div>

      <div class="step">
        <div class="do">STEP 3 — LIKE INTELLIGENTE (2 click)</div>
        <div class="tiny">Prima del DM: 1 like al post + 1 like al commento della persona (se c’è). Poi basta.</div>
        <div class="row" style="margin-top:10px">
          <span class="pill">AZIONE: 2 like e stop</span>
          <span class="pill muted">NO spam</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="step">
        <div class="do">STEP 4 — DM (solo dopo interazione)</div>
        <div class="tiny">Solo se la persona ha risposto/like/visto. Clicca COPIA → incolla → invia.</div>
        <div class="actions left" style="margin-top:10px">
          <button id="btnCopyDM" class="gold">COPIA DM (risolvo)</button>
          <button id="btnCopyDMShort" class="ghost">COPIA DM (brevissimo)</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="step">
        <div class="do">STEP 5 — SALVA CONTATTO (a destra)</div>
        <div class="tiny">Ogni persona trovata: scrivi @nome → Salva. Fine.</div>
      </div>
    </section>

    <!-- RIGHT: SALVA LEAD -->
    <aside class="card">
      <h2>SALVA CONTATTO</h2>

      <label>@nome / nome / azienda</label>
      <input id="leadName" placeholder="Es: @pizzeriaroma" />

      <div class="two">
        <div>
          <label>Piattaforma</label>
          <select id="leadPlatform">
            <option>Instagram</option><option>TikTok</option><option>LinkedIn</option><option>Facebook</option><option>X</option><option>Altro</option>
          </select>
        </div>
        <div>
          <label>Stato</label>
          <select id="leadStatus">
            <option value="NUOVO">NUOVO (trovato)</option>
            <option value="COMMENTATO">COMMENTATO</option>
            <option value="DM_INVIATO">DM INVIATO</option>
            <option value="RISPOSTA">RISPOSTA</option>
            <option value="QUALIFICATO">QUALIFICATO</option>
            <option value="CHIUSO">CHIUSO</option>
            <option value="SCARTATO">SCARTATO</option>
          </select>
        </div>
      </div>

      <label>Dove l’hai trovato? (1 riga)</label>
      <input id="leadWhere" placeholder="Es: ricerca keyword / commenti competitor / gruppo FB" />

      <label>Nota (facoltativa)</label>
      <textarea id="leadNote" placeholder="Es: ha scritto 'non riesco a trovare clienti'"></textarea>

      <div class="actions" style="margin-top:10px">
        <button id="btnSaveLead" class="gold">SALVA CONTATTO</button>
        <button id="btnPasteLast" class="ghost">Incolla ultimo testo copiato</button>
      </div>

      <div class="hr"></div>

      <h2>LISTA CONTATTI</h2>

      <div class="row">
        <div>
          <label>Filtro stato</label>
          <select id="leadFilter">
            <option value="ALL">Tutti</option>
            <option value="NUOVO">NUOVO</option>
            <option value="COMMENTATO">COMMENTATO</option>
            <option value="DM_INVIATO">DM INVIATO</option>
            <option value="RISPOSTA">RISPOSTA</option>
            <option value="QUALIFICATO">QUALIFICATO</option>
            <option value="CHIUSO">CHIUSO</option>
            <option value="SCARTATO">SCARTATO</option>
          </select>
        </div>
        <div>
          <label>Cerca</label>
          <input id="leadSearch" placeholder="cerca..." />
        </div>
      </div>

      <table>
        <thead><tr><th>Contatto</th><th>Stato</th><th>Azioni</th></tr></thead>
        <tbody id="leadRows"></tbody>
      </table>
    </aside>
  </div>
</main>

<script>
(() => {
  const KEY="non_vendiamo_risolviamo_v1";
  const $=(id)=>document.getElementById(id);

  const state = load() ?? {
    settings:{
      niche:"",
      mainPlatform:"instagram",
      keywords:[
        "non riesco a trovare clienti",
        "qualcuno sa come crescere su instagram",
        "mi serve aiuto con i social",
        "come faccio a vendere online",
        "cerco qualcuno che mi segua i social"
      ],
      competitors:[],
      groups:[],
      quota:20,
      timerMin:30
    },
    today:{ date: todayKey(), quota:20, saved:0, lastCopied:"", timerLeftSec:0, timerRunning:false, lastTick:0 },
    leads:[]
  };

  function todayKey(){ return new Date().toISOString().slice(0,10); }
  function load(){ try{return JSON.parse(localStorage.getItem(KEY));}catch{return null;} }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
  function linesToArr(t){ return String(t||"").split("\n").map(x=>x.trim()).filter(Boolean); }
  function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  // --------- LINKS ----------
  function buildLinks(platform, query){
    const q = encodeURIComponent(query);
    if(platform==="instagram"){
      return [
        {name:"Instagram keyword", url:`https://www.instagram.com/explore/search/keyword/?q=${q}`},
        {name:"Google (IG)", url:`https://www.google.com/search?q=site%3Ainstagram.com+${q}`}
      ];
    }
    if(platform==="tiktok"){
      return [
        {name:"TikTok search", url:`https://www.tiktok.com/search?q=${q}`},
        {name:"Google (TikTok)", url:`https://www.google.com/search?q=site%3Atiktok.com+${q}`}
      ];
    }
    if(platform==="linkedin"){
      return [
        {name:"LinkedIn contenuti", url:`https://www.linkedin.com/search/results/content/?keywords=${q}`},
        {name:"LinkedIn persone", url:`https://www.linkedin.com/search/results/people/?keywords=${q}`}
      ];
    }
    if(platform==="facebook"){
      return [
        {name:"Facebook post", url:`https://www.facebook.com/search/posts?q=${q}`},
        {name:"Facebook gruppi", url:`https://www.facebook.com/search/groups?q=${q}`}
      ];
    }
    return [
      {name:"X live", url:`https://x.com/search?q=${q}&src=typed_query&f=live`},
      {name:"Google (X)", url:`https://www.google.com/search?q=site%3Ax.com+${q}`}
    ];
  }

  function guessUrl(text){
    const t = String(text||"").trim();
    if(/^https?:\/\//i.test(t)) return t;
    const q = encodeURIComponent(t);
    return `https://www.google.com/search?q=${q}`;
  }
  function short(s){ s=String(s||""); return s.length>24 ? s.slice(0,24)+"…" : s; }

  function renderSearchLinks(){
    const box = $("searchLinks");
    box.innerHTML = "";

    const platform = state.settings.mainPlatform || "instagram";
    const kws = state.settings.keywords || [];

    const pick = kws.slice(0,3);
    const links = [];
    pick.forEach(k => links.push(...buildLinks(platform, k)));

    (state.settings.competitors||[]).slice(0,2).forEach(c => links.push({name:`Competitor: ${short(c)}`, url: guessUrl(c)}));
    (state.settings.groups||[]).slice(0,2).forEach(g => links.push({name:`Gruppo: ${short(g)}`, url: guessUrl(g)}));

    links.slice(0,10).forEach(l=>{
      const a=document.createElement("a");
      a.className="link";
      a.href=l.url;
      a.target="_blank";
      a.rel="noopener";
      a.textContent="• "+l.name;
      a.style.marginRight="12px";
      a.style.display="inline-block";
      a.style.padding="8px 0";
      box.appendChild(a);
    });

    save();
  }

  // --------- COPY TEXTS (domande che aprono comunicazione) ----------
  function Q1(){ return `Perché secondo te è successo?`; }
  function Q2(){ return `In quel caso cosa hai già provato che non ha funzionato?`; }
  function Q3(){ return `Parlami un attimo del tuo caso: obiettivo e cosa hai provato finora.`; }

  function DM(){
    const niche = state.settings.niche || "il tuo tema";
    return `Ciao! Ho visto quello che hai scritto. Non vendo nulla: provo a capire e risolvere.
Per ${niche} mi serve solo 1 cosa: perché secondo te è successo e cosa hai già provato?`;
  }
  function DMShort(){
    return `Ciao! Non ti vendo nulla: provo a capire. Perché è successo e cosa hai già provato?`;
  }

  async function copyText(text){
    state.today.lastCopied = text;
    $("preview").value = text;
    save();
    try { await navigator.clipboard.writeText(text); } catch {}
  }

  // --------- SETTINGS ----------
  function renderSettings(){
    $("niche").value = state.settings.niche || "";
    $("mainPlatform").value = state.settings.mainPlatform || "instagram";
    $("keywords").value = (state.settings.keywords||[]).join("\n");
    $("competitors").value = (state.settings.competitors||[]).join("\n");
    $("groups").value = (state.settings.groups||[]).join("\n");
    $("quota").value = String(state.settings.quota || 20);
    $("timerMin").value = String(state.settings.timerMin || 30);
  }

  function saveSettings(){
    state.settings.niche = $("niche").value.trim();
    state.settings.mainPlatform = $("mainPlatform").value;
    state.settings.keywords = linesToArr($("keywords").value);
    state.settings.competitors = linesToArr($("competitors").value);
    state.settings.groups = linesToArr($("groups").value);
    state.settings.quota = Number($("quota").value || 20);
    state.settings.timerMin = Number($("timerMin").value || 30);
    save();
  }

  function generateDay(){
    saveSettings();
    rolloverDayIfNeeded(true);
    renderSearchLinks();
    renderProgress();
    renderTimerPill();
  }

  function rolloverDayIfNeeded(force=false){
    const tk = todayKey();
    const quota = Number(state.settings.quota || 20);
    if(force || state.today.date !== tk){
      state.today = {
        date: tk,
        quota,
        saved: 0,
        lastCopied: state.today.lastCopied || "",
        timerLeftSec: Number(state.settings.timerMin||30) * 60,
        timerRunning: false,
        lastTick: 0
      };
      save();
    } else {
      state.today.quota = quota;
      if(!state.today.timerLeftSec || state.today.timerLeftSec<=0){
        state.today.timerLeftSec = Number(state.settings.timerMin||30) * 60;
      }
      save();
    }
  }

  // --------- TIMER ----------
  let tickHandle = null;

  function startTimer(){
    rolloverDayIfNeeded(false);
    state.today.timerRunning = true;
    state.today.lastTick = Date.now();
    save();
    if(!tickHandle){
      tickHandle = setInterval(tick, 500);
    }
    renderTimerPill();
  }

  function stopTimer(){
    state.today.timerRunning = false;
    save();
    renderTimerPill();
  }

  function tick(){
    if(!state.today.timerRunning) return;
    const now = Date.now();
    const dt = Math.max(0, Math.floor((now - state.today.lastTick)/1000));
    if(dt<=0) return;
    state.today.lastTick = now;
    state.today.timerLeftSec = Math.max(0, (state.today.timerLeftSec||0) - dt);
    save();
    renderTimerPill();
    if(state.today.timerLeftSec<=0){
      state.today.timerRunning = false;
      save();
      renderTimerPill(true);
    }
  }

  function fmt(sec){
    sec = Math.max(0, Number(sec||0));
    const m = Math.floor(sec/60);
    const s = sec%60;
    return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
  }

  function renderTimerPill(done=false){
    const sec = state.today.timerLeftSec ?? (Number(state.settings.timerMin||30)*60);
    $("timerPill").textContent = `Timer: ${fmt(sec)}`;
    $("timerPill").className = "pill " + (done ? "warn" : "muted");
  }

  // --------- PROGRESS ----------
  function renderProgress(){
    const q = Number(state.today.quota || state.settings.quota || 20);
    const s = Number(state.today.saved || 0);
    $("progressPill").textContent = `Oggi: ${s} / ${q} contatti salvati`;
    $("progressPill").className = "pill " + (s>=q ? "ok" : "muted");
  }

  function newDay(){
    rolloverDayIfNeeded(true);
    renderProgress();
    renderTimerPill();
  }

  // --------- LEADS ----------
  function saveLead(){
    const name = $("leadName").value.trim();
    if(!name) return;

    const lead = {
      id: uid(),
      createdAt: new Date().toISOString(),
      name,
      platform: $("leadPlatform").value,
      status: $("leadStatus").value,
      where: $("leadWhere").value.trim(),
      note: $("leadNote").value.trim(),
      lastText: state.today.lastCopied || ""
    };
    state.leads.unshift(lead);

    rolloverDayIfNeeded(false);
    state.today.saved = (state.today.saved||0) + 1;

    $("leadName").value="";
    $("leadWhere").value="";
    $("leadNote").value="";
    save();
    renderLeads();
    renderProgress();
  }

  function renderLeads(){
    const tbody = $("leadRows");
    tbody.innerHTML = "";

    const f = $("leadFilter").value;
    const q = $("leadSearch").value.trim().toLowerCase();

    const list = (state.leads||[]).filter(l=>{
      const okS = (f==="ALL") || l.status===f;
      const hay = `${l.name} ${l.platform} ${l.status} ${l.where} ${l.note}`.toLowerCase();
      const okQ = !q || hay.includes(q);
      return okS && okQ;
    });

    list.forEach(l=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>
          <b>${esc(l.name)}</b>
          <div class="tiny">${esc(l.platform)} • ${new Date(l.createdAt).toLocaleString()}</div>
          <div class="tiny">${esc(l.where||"")}</div>
          <div class="tiny mono">${esc((l.note||"").slice(0,90))}${(l.note||"").length>90?"…":""}</div>
        </td>
        <td><span class="pill">${esc(l.status)}</span></td>
        <td>
          <div class="row" style="gap:8px">
            <button data-a="copy" data-id="${l.id}" class="ghost">Copia testo</button>
            <button data-a="next" data-id="${l.id}" class="gold">Avanza</button>
            <button data-a="del" data-id="${l.id}" class="danger">X</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-a]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        const a = btn.dataset.a;
        const lead = state.leads.find(x=>x.id===id);
        if(!lead) return;

        if(a==="copy"){
          const txt = lead.lastText || "";
          state.today.lastCopied = txt;
          $("preview").value = txt;
          save();
          try { await navigator.clipboard.writeText(txt); } catch {}
        }

        if(a==="next"){
          const order=["NUOVO","COMMENTATO","DM_INVIATO","RISPOSTA","QUALIFICATO","CHIUSO"];
          const i=order.indexOf(lead.status);
          lead.status = order[Math.min(order.length-1, Math.max(0,i+1))] || lead.status;
          save(); renderLeads();
        }

        if(a==="del"){
          state.leads = state.leads.filter(x=>x.id!==id);
          save(); renderLeads();
        }
      };
    });
  }

  // --------- Export/Import/Reset ----------
  function exportJson(){
    const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="non-vendiamo-risolviamo.json"; a.click();
    URL.revokeObjectURL(url);
  }
  function importJson(){
    const inp=document.createElement("input");
    inp.type="file"; inp.accept="application/json";
    inp.onchange=()=>{
      const f=inp.files?.[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          const obj=JSON.parse(String(r.result||""));
          if(!obj) return;
          state.settings = obj.settings || state.settings;
          state.today = obj.today || state.today;
          state.leads = obj.leads || state.leads;
          save();
          init();
        }catch{}
      };
      r.readAsText(f);
    };
    inp.click();
  }
  function resetAll(){
    localStorage.removeItem(KEY);
    location.reload();
  }

  // --------- Events ----------
  $("btnSave").onclick = ()=>saveSettings();
  $("btnGenerate").onclick = generateDay;

  $("btnCopyQ1").onclick = ()=>copyText(Q1());
  $("btnCopyQ2").onclick = ()=>copyText(Q2());
  $("btnCopyQ3").onclick = ()=>copyText(Q3());

  $("btnCopyDM").onclick = ()=>copyText(DM());
  $("btnCopyDMShort").onclick = ()=>copyText(DMShort());

  $("btnSaveLead").onclick = saveLead;
  $("btnPasteLast").onclick = ()=>{ $("leadNote").value = state.today.lastCopied || ""; };

  $("leadFilter").onchange = renderLeads;
  $("leadSearch").oninput = renderLeads;

  $("btnStartTimer").onclick = startTimer;
  $("btnStopTimer").onclick = stopTimer;
  $("btnNewDay").onclick = newDay;

  $("btnExport").onclick = exportJson;
  $("btnImport").onclick = importJson;
  $("btnReset").onclick = resetAll;

  // --------- Init ----------
  function init(){
    rolloverDayIfNeeded(false);
    renderSettings();
    renderSearchLinks();
    renderLeads();
    renderProgress();
    renderTimerPill();
    $("preview").value = "";
  }
  init();
})();
</script>
</body>
</html>
